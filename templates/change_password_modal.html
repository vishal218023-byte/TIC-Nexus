<!-- Change Password Modal Component -->
<div x-data="changePasswordModal()" @open-password-modal.window="openModal()" x-cloak>
    <div x-show="showModal" class="modal" :class="{'is-active': showModal}">
        <div class="modal-background" @click="closeModal"></div>
        <div class="modal-card">
            <header class="modal-card-head has-background-info">
                <p class="modal-card-title has-text-white">
                    <i class="fas fa-key mr-2"></i>Change Password
                </p>
                <button class="delete" @click="closeModal" aria-label="close"></button>
            </header>
            <section class="modal-card-body">
                <!-- Success Message -->
                <div x-show="successMessage" x-transition class="notification is-success is-light mb-4">
                    <button class="delete" @click="successMessage = ''"></button>
                    <span x-text="successMessage"></span>
                </div>

                <!-- Error Message -->
                <div x-show="errorMessage" x-transition class="notification is-danger is-light mb-4">
                    <button class="delete" @click="errorMessage = ''"></button>
                    <span x-text="errorMessage"></span>
                </div>

                <form @submit.prevent="changePassword">
                    <div class="field">
                        <label class="label">Current Password *</label>
                        <div class="control has-icons-left">
                            <input 
                                x-model="passwordForm.currentPassword"
                                class="input" 
                                type="password" 
                                placeholder="Enter your current password"
                                required
                                :disabled="loading">
                            <span class="icon is-small is-left">
                                <i class="fas fa-lock"></i>
                            </span>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">New Password *</label>
                        <div class="control has-icons-left">
                            <input 
                                x-model="passwordForm.newPassword"
                                @input="checkPasswordStrength"
                                class="input" 
                                type="password" 
                                placeholder="Enter your new password (min 8 characters)"
                                required
                                :disabled="loading">
                            <span class="icon is-small is-left">
                                <i class="fas fa-key"></i>
                            </span>
                        </div>
                        <p class="help">Minimum 8 characters with letters and numbers</p>
                    </div>

                    <!-- Password Strength Indicator -->
                    <div x-show="passwordStrength.score > 0" class="field">
                        <div class="level is-mobile mb-2">
                            <div class="level-left">
                                <span class="level-item has-text-weight-semibold is-size-7">Strength:</span>
                            </div>
                            <div class="level-right">
                                <span class="level-item has-text-weight-semibold is-size-7" 
                                      :class="{
                                          'has-text-danger': passwordStrength.strength === 'weak',
                                          'has-text-warning': passwordStrength.strength === 'medium',
                                          'has-text-success': passwordStrength.strength === 'strong'
                                      }"
                                      x-text="passwordStrength.strength.toUpperCase()">
                                </span>
                            </div>
                        </div>
                        <progress 
                            class="progress is-small"
                            :class="{
                                'is-danger': passwordStrength.strength === 'weak',
                                'is-warning': passwordStrength.strength === 'medium',
                                'is-success': passwordStrength.strength === 'strong'
                            }"
                            :value="passwordStrength.score" 
                            max="100">
                        </progress>
                        <div x-show="passwordStrength.feedback.length > 0" class="mt-2">
                            <template x-for="msg in passwordStrength.feedback" :key="msg">
                                <p class="help is-size-7" x-text="msg"></p>
                            </template>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">Confirm New Password *</label>
                        <div class="control has-icons-left">
                            <input 
                                x-model="passwordForm.confirmPassword"
                                class="input" 
                                type="password" 
                                placeholder="Confirm your new password"
                                required
                                :disabled="loading">
                            <span class="icon is-small is-left">
                                <i class="fas fa-check"></i>
                            </span>
                        </div>
                    </div>

                    <div class="notification is-info is-light">
                        <p class="has-text-weight-semibold mb-2 is-size-7">
                            <i class="fas fa-info-circle mr-2"></i>Requirements:
                        </p>
                        <ul class="is-size-7 ml-4">
                            <li>At least 8 characters</li>
                            <li>Contains letters and numbers</li>
                            <li>Different from current password</li>
                            <li>Cannot reuse last 3 passwords</li>
                        </ul>
                    </div>
                </form>
            </section>
            <footer class="modal-card-foot">
                <button 
                    @click="changePassword" 
                    class="button is-success"
                    :class="{'is-loading': loading}"
                    :disabled="loading">
                    <span class="icon">
                        <i class="fas fa-save"></i>
                    </span>
                    <span>Change Password</span>
                </button>
                <button @click="closeModal" class="button">Cancel</button>
            </footer>
        </div>
    </div>
</div>

<script>
    function changePasswordModal() {
        return {
            showModal: false,
            loading: false,
            successMessage: '',
            errorMessage: '',
            passwordForm: {
                currentPassword: '',
                newPassword: '',
                confirmPassword: ''
            },
            passwordStrength: {
                strength: '',
                score: 0,
                feedback: []
            },

            openModal() {
                this.showModal = true;
                this.resetForm();
            },

            closeModal() {
                this.showModal = false;
                this.resetForm();
            },

            resetForm() {
                this.passwordForm = {
                    currentPassword: '',
                    newPassword: '',
                    confirmPassword: ''
                };
                this.passwordStrength = { strength: '', score: 0, feedback: [] };
                this.successMessage = '';
                this.errorMessage = '';
            },

            async checkPasswordStrength() {
                if (this.passwordForm.newPassword.length < 1) {
                    this.passwordStrength = { strength: '', score: 0, feedback: [] };
                    return;
                }

                try {
                    const response = await fetch(`/api/auth/check-password-strength?password=${encodeURIComponent(this.passwordForm.newPassword)}`);
                    if (response.ok) {
                        this.passwordStrength = await response.json();
                    }
                } catch (error) {
                    console.error('Error checking password strength:', error);
                }
            },

            async changePassword() {
                this.errorMessage = '';
                this.successMessage = '';

                // Client-side validation
                if (!this.passwordForm.currentPassword) {
                    this.errorMessage = 'Please enter your current password';
                    return;
                }

                if (this.passwordForm.newPassword.length < 8) {
                    this.errorMessage = 'New password must be at least 8 characters long';
                    return;
                }

                if (this.passwordForm.newPassword !== this.passwordForm.confirmPassword) {
                    this.errorMessage = 'New passwords do not match';
                    return;
                }

                if (this.passwordForm.currentPassword === this.passwordForm.newPassword) {
                    this.errorMessage = 'New password must be different from current password';
                    return;
                }

                this.loading = true;

                try {
                    const token = localStorage.getItem('access_token');
                    const response = await fetch('/api/auth/change-password', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            current_password: this.passwordForm.currentPassword,
                            new_password: this.passwordForm.newPassword
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Show toast notification
                        window.toast.success(data.message || 'Password changed successfully!');
                        
                        // Clear form and close modal
                        this.resetForm();
                        this.closeModal();
                    } else {
                        this.errorMessage = data.detail || 'Failed to change password';
                    }
                } catch (error) {
                    this.errorMessage = 'An error occurred. Please try again.';
                    console.error('Password change error:', error);
                } finally {
                    this.loading = false;
                }
            }
        }
    }

    // Global function to open the modal from anywhere
    window.openChangePasswordModal = function() {
        console.log('openChangePasswordModal called - dispatching event');
        // Dispatch a custom event that Alpine will listen to
        window.dispatchEvent(new CustomEvent('open-password-modal'));
    }
</script>

<style>
    [x-cloak] { display: none !important; }
</style>
