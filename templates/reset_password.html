{% extends "base.html" %}

{% block title %}Reset Password - TIC Nexus{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center" style="background: linear-gradient(135deg, #052c52 0%, #0a4c7d 100%);">
    <div class="bg-white rounded-xl shadow-2xl p-10 w-full max-w-md" x-data="resetPasswordForm()">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold" style="color: #052c52;">Reset Your Password</h1>
            <p class="text-slate-600 mt-2">Enter the token provided by your administrator</p>
        </div>

        <!-- Success Message -->
        <div x-show="success" x-transition class="bg-emerald-50 border border-emerald-200 text-emerald-700 px-4 py-3 rounded-lg mb-4" role="alert">
            <div class="flex items-center">
                <i class="fas fa-check-circle mr-2"></i>
                <span x-text="successMessage"></span>
            </div>
            <div class="mt-3">
                <a href="/login" class="text-sm font-semibold underline">Click here to login</a>
            </div>
        </div>

        <!-- Error Message -->
        <div x-show="error" x-transition class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4" role="alert">
            <span x-text="error"></span>
        </div>

        <form @submit.prevent="handleReset" x-show="!success">
            <!-- Reset Token -->
            <div class="mb-6">
                <label class="block text-slate-700 text-sm font-semibold mb-2" for="token">
                    Reset Token *
                </label>
                <input 
                    x-model="token"
                    class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 transition uppercase"
                    id="token" 
                    type="text" 
                    placeholder="Enter 8-character token (e.g., ABC12XY5)"
                    maxlength="8"
                    required
                    style="text-transform: uppercase;"
                >
                <p class="text-xs text-slate-500 mt-1">Enter the token exactly as provided by your administrator</p>
            </div>

            <!-- New Password -->
            <div class="mb-4">
                <label class="block text-slate-700 text-sm font-semibold mb-2" for="newPassword">
                    New Password *
                </label>
                <input 
                    x-model="newPassword"
                    @input="checkPasswordStrength"
                    class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 transition"
                    id="newPassword" 
                    type="password" 
                    placeholder="Enter your new password"
                    required
                >
            </div>

            <!-- Confirm Password -->
            <div class="mb-4">
                <label class="block text-slate-700 text-sm font-semibold mb-2" for="confirmPassword">
                    Confirm Password *
                </label>
                <input 
                    x-model="confirmPassword"
                    class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 transition"
                    id="confirmPassword" 
                    type="password" 
                    placeholder="Confirm your new password"
                    required
                >
            </div>

            <!-- Password Strength Indicator -->
            <div x-show="passwordStrength.score > 0" class="mb-4">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-xs font-semibold text-slate-600">Password Strength:</span>
                    <span class="text-xs font-semibold" 
                          :class="{
                              'text-red-600': passwordStrength.strength === 'weak',
                              'text-amber-600': passwordStrength.strength === 'medium',
                              'text-emerald-600': passwordStrength.strength === 'strong'
                          }"
                          x-text="passwordStrength.strength.toUpperCase()">
                    </span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-2">
                    <div class="h-2 rounded-full transition-all duration-300"
                         :class="{
                             'bg-red-500': passwordStrength.strength === 'weak',
                             'bg-amber-500': passwordStrength.strength === 'medium',
                             'bg-emerald-500': passwordStrength.strength === 'strong'
                         }"
                         :style="`width: ${passwordStrength.score}%`">
                    </div>
                </div>
                <div class="mt-2" x-show="passwordStrength.feedback.length > 0">
                    <template x-for="msg in passwordStrength.feedback" :key="msg">
                        <p class="text-xs text-slate-600" x-text="'â€¢ ' + msg"></p>
                    </template>
                </div>
            </div>

            <!-- Password Requirements -->
            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 mb-6">
                <h4 class="text-sm font-semibold text-slate-700 mb-2">Password Requirements:</h4>
                <ul class="text-xs text-slate-600 space-y-1">
                    <li><i class="fas fa-check text-emerald-500 mr-1"></i>At least 8 characters</li>
                    <li><i class="fas fa-check text-emerald-500 mr-1"></i>Contains letters and numbers</li>
                    <li><i class="fas fa-info-circle text-blue-500 mr-1"></i>Mix of uppercase and lowercase (recommended)</li>
                    <li><i class="fas fa-info-circle text-blue-500 mr-1"></i>Special characters (recommended)</li>
                </ul>
            </div>

            <!-- Submit Button -->
            <button 
                type="submit"
                :disabled="loading"
                class="w-full text-white font-semibold py-3 px-4 rounded-lg transition duration-200 shadow-lg hover:shadow-xl disabled:opacity-50"
                style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <span x-show="!loading"><i class="fas fa-key mr-2"></i>Reset Password</span>
                <span x-show="loading"><i class="fas fa-spinner fa-spin mr-2"></i>Resetting...</span>
            </button>
        </form>

        <!-- Back to Login -->
        <div class="mt-6 text-center">
            <a href="/login" class="text-sm text-slate-600 hover:text-slate-800 hover:underline">
                <i class="fas fa-arrow-left mr-1"></i>Back to Login
            </a>
        </div>
    </div>
</div>

<script>
    function resetPasswordForm() {
        return {
            token: '',
            newPassword: '',
            confirmPassword: '',
            error: '',
            success: false,
            successMessage: '',
            loading: false,
            passwordStrength: {
                strength: '',
                score: 0,
                feedback: []
            },

            async checkPasswordStrength() {
                if (this.newPassword.length < 1) {
                    this.passwordStrength = { strength: '', score: 0, feedback: [] };
                    return;
                }

                try {
                    const response = await fetch(`/api/auth/check-password-strength?password=${encodeURIComponent(this.newPassword)}`);
                    if (response.ok) {
                        this.passwordStrength = await response.json();
                    }
                } catch (error) {
                    console.error('Error checking password strength:', error);
                }
            },

            async handleReset() {
                this.error = '';
                this.success = false;

                // Validate inputs
                if (!this.token || this.token.length !== 8) {
                    this.error = 'Please enter a valid 8-character reset token';
                    return;
                }

                if (this.newPassword.length < 8) {
                    this.error = 'Password must be at least 8 characters long';
                    return;
                }

                if (this.newPassword !== this.confirmPassword) {
                    this.error = 'Passwords do not match';
                    return;
                }

                this.loading = true;

                try {
                    const response = await fetch('/api/auth/reset-password-with-token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            token: this.token.toUpperCase().trim(),
                            new_password: this.newPassword
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        this.success = true;
                        this.successMessage = data.message || 'Password reset successfully!';
                        // Redirect to login after 3 seconds
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 3000);
                    } else {
                        this.error = data.detail || 'Password reset failed. Please try again.';
                    }
                } catch (error) {
                    this.error = 'An error occurred. Please try again.';
                    console.error('Reset error:', error);
                } finally {
                    this.loading = false;
                }
            }
        }
    }
</script>
{% endblock %}
