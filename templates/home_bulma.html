{% extends "base.html" %}

{% block title %}TIC Nexus - Technical Information Center{% endblock %}

{% block content %}
<div class="hero-gradient" style="min-height: 100vh;">
    <!-- Navbar -->
    <nav class="navbar is-white is-fixed-top has-shadow" role="navigation" aria-label="main navigation" x-data="navbarApp()">
        <div class="container">
            <div class="navbar-brand">
                <a class="navbar-item" href="/">
                    <div class="has-gradient-navy is-flex is-align-items-center is-justify-content-center" style="width: 48px; height: 48px; border-radius: 8px; margin-right: 12px;">
                        <span class="icon is-large has-text-white">
                            <i class="fas fa-book fa-lg"></i>
                        </span>
                    </div>
                    <div>
                        <p class="navbar-brand-text mb-0">TIC Nexus</p>
                        <p class="navbar-brand-subtext">Bharat Electronics Limited</p>
                    </div>
                </a>

                <a role="button" class="navbar-burger" :class="{ 'is-active': mobileMenuActive }" @click="mobileMenuActive = !mobileMenuActive" aria-label="menu" aria-expanded="false">
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                </a>
            </div>

            <div class="navbar-menu" :class="{ 'is-active': mobileMenuActive }">
                <div class="navbar-end">
                    <a class="navbar-item has-text-weight-semibold" href="/">
                        <span class="icon">
                            <i class="fas fa-home"></i>
                        </span>
                        <span>Home</span>
                    </a>
                    <a class="navbar-item has-text-weight-semibold" href="/public/digital-library">
                        <span class="icon">
                            <i class="fas fa-book-open"></i>
                        </span>
                        <span>Digital Library</span>
                    </a>
                    
                    <!-- Show when NOT logged in -->
                    <div class="navbar-item" x-show="!isLoggedIn">
                        <div class="buttons">
                            <a href="/login" class="button has-gradient-emerald has-text-weight-bold">
                                <span class="icon">
                                    <i class="fas fa-sign-in-alt"></i>
                                </span>
                                <span>Login</span>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Show when logged in -->
                    <div x-show="isLoggedIn" class="navbar-item has-dropdown is-hoverable">
                        <a class="navbar-link">
                            <span class="icon has-text-success">
                                <i class="fas fa-user-circle"></i>
                            </span>
                            <span x-text="username" class="has-text-weight-semibold"></span>
                        </a>
                        <div class="navbar-dropdown is-right">
                            <a class="navbar-item" href="/dashboard">
                                <span class="icon has-text-info">
                                    <i class="fas fa-tachometer-alt"></i>
                                </span>
                                <span>Dashboard</span>
                            </a>
                            <a class="navbar-item" href="/circulation">
                                <span class="icon has-text-primary">
                                    <i class="fas fa-exchange-alt"></i>
                                </span>
                                <span>Circulation</span>
                            </a>
                            <hr class="navbar-divider">
                            <a class="navbar-item" @click.prevent="logout">
                                <span class="icon has-text-danger">
                                    <i class="fas fa-sign-out-alt"></i>
                                </span>
                                <span>Logout</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero is-medium" style="margin-top: 52px;">
        <div class="hero-body">
            <div class="container">
                <div class="columns is-centered">
                    <div class="column is-10 has-text-centered">
                        <h1 class="title is-1 has-text-weight-bold mb-5 animate__animated animate__fadeInDown" style="color: #052c52; font-size: 3.5rem;">
                            Technical Information Center
                        </h1>
                        <p class="subtitle is-4 has-text-grey mb-4 animate__animated animate__fadeInUp animate__delay-1s">
                            Your gateway to technical knowledge and resources
                        </p>
                        <p class="subtitle is-5 has-text-grey-light animate__animated animate__fadeInUp animate__delay-2s">
                            Search through our extensive collection of books, manuals, and technical documents
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Search Section -->
    <section class="section">
        <div class="container">
            <div class="columns is-centered">
                <div class="column is-10" x-data="searchBooks()">
                    <div class="box has-shadow-large animate__animated animate__fadeInUp" style="border-radius: 16px;">
                        <!-- Search Input -->
                        <div class="field is-grouped">
                            <div class="control is-expanded has-icons-left">
                                <input 
                                    x-model="searchQuery"
                                    @keyup.enter="performSearch"
                                    class="input is-large" 
                                    type="text" 
                                    placeholder="Search by title, author, ISBN, or accession number..."
                                >
                                <span class="icon is-left is-large">
                                    <i class="fas fa-search"></i>
                                </span>
                            </div>
                            <div class="control">
                                <button 
                                    @click="performSearch"
                                    :class="{ 'is-loading': loading }"
                                    class="button is-large has-gradient-emerald has-text-weight-bold"
                                >
                                    <span class="icon">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <span>Search</span>
                                </button>
                            </div>
                        </div>

                        <!-- Search Results -->
                        <div x-show="searchResults.length > 0 || showNoResults" class="mt-5">
                            <div x-show="showNoResults && searchResults.length === 0">
                                <article class="message is-info">
                                    <div class="message-body">
                                        <span class="icon">
                                            <i class="fas fa-info-circle"></i>
                                        </span>
                                        No books found matching your search.
                                    </div>
                                </article>
                            </div>
                            
                            <div x-show="searchResults.length > 0" style="max-height: 500px; overflow-y: auto; padding: 0.5rem;">
                                <template x-for="book in searchResults" :key="book.id">
                                    <div class="box mb-3 animate__animated animate__fadeIn has-hover-lift" style="overflow: hidden;">
                                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                            <!-- Title and Author -->
                                            <div>
                                                <h4 class="title is-5 mb-2" style="color: #052c52; word-break: break-word; line-height: 1.4; margin-bottom: 0.5rem !important;" x-text="book.title"></h4>
                                                <p class="subtitle is-6 has-text-grey" style="word-break: break-word; line-height: 1.5; margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                                    <span class="icon" style="margin: 0;">
                                                        <i class="fas fa-user"></i>
                                                    </span>
                                                    <span x-text="book.author"></span>
                                                </p>
                                            </div>
                                            
                                            <!-- Tags and Status -->
                                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                                <div class="tags mb-0" style="flex-wrap: wrap;">
                                                    <span class="tag is-light">
                                                        <span class="icon is-small">
                                                            <i class="fas fa-tag"></i>
                                                        </span>
                                                        <span x-text="book.acc_no"></span>
                                                    </span>
                                                    <span x-show="book.subject" class="tag is-light" :title="book.subject">
                                                        <span class="icon is-small">
                                                            <i class="fas fa-book"></i>
                                                        </span>
                                                        <span x-text="book.subject.length > 20 ? book.subject.substring(0, 20) + '...' : book.subject"></span>
                                                    </span>
                                                    <span x-show="book.isbn" class="tag is-light">
                                                        <span class="icon is-small">
                                                            <i class="fas fa-barcode"></i>
                                                        </span>
                                                        <span x-text="book.isbn"></span>
                                                    </span>
                                                    <span x-show="book.language" class="tag is-info is-light">
                                                        <span class="icon is-small">
                                                            <i class="fas fa-language"></i>
                                                        </span>
                                                        <span x-text="book.language"></span>
                                                    </span>
                                                </div>
                                                <div style="flex-shrink: 0;">
                                                    <span x-show="book.is_issued" class="tag is-danger is-medium">
                                                        <span class="icon">
                                                            <i class="fas fa-times-circle"></i>
                                                        </span>
                                                        <span>Issued</span>
                                                    </span>
                                                    <span x-show="!book.is_issued" class="tag is-success is-medium">
                                                        <span class="icon">
                                                            <i class="fas fa-check-circle"></i>
                                                        </span>
                                                        <span>Available</span>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Statistics -->
                        <div class="mt-6 pt-5" style="border-top: 1px solid #e5e7eb;">
                            <div class="columns is-multiline has-text-centered">
                                <div class="column is-3" x-data="{ count: 0 }" x-init="fetch('/api/public/stats').then(r => r.json()).then(d => count = d.total_books)">
                                    <p class="title is-2 has-text-success" x-text="count">0</p>
                                    <p class="subtitle is-6 has-text-grey">Total Books</p>
                                </div>
                                <div class="column is-3" x-data="{ count: 0 }" x-init="fetch('/api/public/stats').then(r => r.json()).then(d => count = d.available_books)">
                                    <p class="title is-2" style="color: #052c52;" x-text="count">0</p>
                                    <p class="subtitle is-6 has-text-grey">Available</p>
                                </div>
                                <div class="column is-3" x-data="{ count: 0 }" x-init="fetch('/api/public/stats').then(r => r.json()).then(d => count = d.digital_library_count)">
                                    <p class="title is-2 has-text-purple" x-text="count">0</p>
                                    <p class="subtitle is-6 has-text-grey">Digital Library</p>
                                </div>
                                <div class="column is-3" x-data="{ count: 0 }" x-init="fetch('/api/public/stats').then(r => r.json()).then(d => count = d.subjects_count)">
                                    <p class="title is-2 has-text-info" x-text="count">0</p>
                                    <p class="subtitle is-6 has-text-grey">Subjects</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section id="features" class="section has-background-white">
        <div class="container">
            <div class="has-text-centered mb-6">
                <h2 class="title is-2 has-text-weight-bold mb-3" style="color: #052c52;">Powerful Features</h2>
                <p class="subtitle is-4 has-text-grey">Everything you need to manage your technical library</p>
            </div>

            <div class="columns is-multiline">
                <!-- Feature 1 -->
                <div class="column is-4">
                    <div class="box has-shadow has-hover-lift animate__animated animate__fadeInUp" style="height: 100%; border-radius: 12px;">
                        <div class="has-text-centered">
                            <div class="has-gradient-emerald is-inline-flex is-align-items-center is-justify-content-center mb-4" 
                                 style="width: 80px; height: 80px; border-radius: 50%;">
                                <span class="icon is-large has-text-white">
                                    <i class="fas fa-search fa-2x"></i>
                                </span>
                            </div>
                            <h4 class="title is-4 mb-3" style="color: #052c52;">Smart Search</h4>
                            <p class="has-text-grey">
                                Instantly find books by title, author, ISBN, or accession number with our powerful search engine.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Feature 2 -->
                <div class="column is-4">
                    <div class="box has-shadow has-hover-lift animate__animated animate__fadeInUp animate__delay-1s" style="height: 100%; border-radius: 12px;">
                        <div class="has-text-centered">
                            <div class="has-gradient-navy is-inline-flex is-align-items-center is-justify-content-center mb-4" 
                                 style="width: 80px; height: 80px; border-radius: 50%;">
                                <span class="icon is-large has-text-white">
                                    <i class="fas fa-book-open fa-2x"></i>
                                </span>
                            </div>
                            <h4 class="title is-4 mb-3" style="color: #052c52;">Digital Library</h4>
                            <p class="has-text-grey">
                                Access digital versions of technical documents and manuals anytime, anywhere.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Feature 3 -->
                <div class="column is-4">
                    <div class="box has-shadow has-hover-lift animate__animated animate__fadeInUp animate__delay-2s" style="height: 100%; border-radius: 12px;">
                        <div class="has-text-centered">
                            <div class="is-inline-flex is-align-items-center is-justify-content-center mb-4" 
                                 style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);">
                                <span class="icon is-large has-text-white">
                                    <i class="fas fa-clipboard-list fa-2x"></i>
                                </span>
                            </div>
                            <h4 class="title is-4 mb-3" style="color: #052c52;">Circulation Management</h4>
                            <p class="has-text-grey">
                                Efficiently manage book issues, returns, and track overdue items with our automated system.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- About Section -->
    <section id="about" class="section">
        <div class="container">
            <div class="columns is-centered">
                <div class="column is-8 has-text-centered">
                    <h2 class="title is-2 has-text-weight-bold mb-5" style="color: #052c52;">About TIC Nexus</h2>
                    <div class="content is-medium has-text-grey mb-5" style="line-height: 1.8;">
                        <p>
                            The Technical Information Center (TIC) Nexus is a comprehensive library management system designed specifically for 
                            Bharat Electronics Limited. Our platform provides seamless access to technical documentation, research materials, 
                            and engineering resources to support innovation and knowledge sharing.
                        </p>
                    </div>
                    <div class="box has-shadow-large" style="border-radius: 16px;">
                        <p class="has-text-grey mb-4">
                            <span class="icon has-text-success">
                                <i class="fas fa-info-circle"></i>
                            </span>
                            <strong>Need access?</strong> Login with your credentials to access the full system.
                        </p>
                        <a href="/login" class="button is-large has-gradient-emerald has-text-weight-bold">
                            <span class="icon">
                                <i class="fas fa-rocket"></i>
                            </span>
                            <span>Get Started</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer has-background-dark has-text-white">
        <div class="content has-text-centered">
            <h4 class="title is-4 has-text-white mb-2">TIC Nexus</h4>
            <p class="has-text-grey-light mb-4">Bharat Electronics Limited - Technical Information Center</p>
            <p class="is-size-7 has-text-grey-light mb-2">
                &copy; 2026 BEL. All rights reserved.
            </p>
            <p class="is-size-7 has-text-grey">
                Developed by <span class="has-text-success has-text-weight-semibold">Vishal Raj V</span> (E218023)
            </p>
        </div>
    </footer>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function navbarApp() {
        return {
            mobileMenuActive: false,
            isLoggedIn: false,
            username: '',
            userRole: '',
            dashboardUrl: '/dashboard',

            init() {
                // Check if user is logged in
                const token = localStorage.getItem('access_token');
                const role = localStorage.getItem('user_role');
                
                if (token) {
                    this.isLoggedIn = true;
                    this.userRole = role || '';
                    this.getUserInfo();
                }
            },

            async getUserInfo() {
                const token = localStorage.getItem('access_token');
                try {
                    const response = await fetch('/api/user/me', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const user = await response.json();
                        this.username = user.username;
                    } else {
                        // Token invalid, clear storage
                        this.logout();
                    }
                } catch (error) {
                    console.error('Error fetching user info:', error);
                }
            },

            logout() {
                localStorage.removeItem('access_token');
                localStorage.removeItem('user_role');
                localStorage.removeItem('user_id');
                this.isLoggedIn = false;
                this.username = '';
                window.location.href = '/';
            }
        }
    }

    function searchBooks() {
        return {
            searchQuery: '',
            searchResults: [],
            showNoResults: false,
            loading: false,

            async performSearch() {
                if (!this.searchQuery.trim()) {
                    this.searchResults = [];
                    this.showNoResults = false;
                    return;
                }

                this.loading = true;
                this.showNoResults = false;

                try {
                    const response = await fetch(`/api/public/search?q=${encodeURIComponent(this.searchQuery)}`);
                    const data = await response.json();
                    
                    this.searchResults = data;
                    this.showNoResults = data.length === 0;
                } catch (error) {
                    console.error('Search error:', error);
                    this.searchResults = [];
                    this.showNoResults = true;
                } finally {
                    this.loading = false;
                }
            }
        }
    }
</script>
{% endblock %}
