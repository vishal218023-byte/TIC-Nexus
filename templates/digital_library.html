{% extends "base.html" %}

{% block title %}Digital Library - TIC Nexus{% endblock %}

{% block extra_css %}
<script src="/static/js/auth-check.js"></script>
{% endblock %}

{% block content %}
<div class="columns is-gapless" style="min-height: 100vh;" x-data="digitalLibraryApp()">
    <!-- Sidebar -->
    {% set active_page = 'digital-library' %}
    {% include 'sidebar.html' %}

    <!-- Main Content -->
    <main class="column" style="background-color: #f8fafc;">
        <div class="section">
            <div class="container is-fluid">
                <h2 class="title is-3 has-text-grey-dark mb-5">Digital Library</h2>

                <!-- Search and Filters -->
                <div class="box mb-5">
                    <div class="columns">
                        <div class="column">
                            <div class="field">
                                <div class="control has-icons-left">
                                    <input 
                                        x-model="searchQuery"
                                        @input="searchBooks"
                                        type="text" 
                                        placeholder="Search digital books..."
                                        class="input"
                                    >
                                    <span class="icon is-left">
                                        <i class="fas fa-search"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="column">
                            <div class="field">
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select x-model="filterSubject" @change="searchBooks">
                                            <option value="">All Subjects</option>
                                            <template x-for="subject in subjects" :key="subject">
                                                <option :value="subject" x-text="subject"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Books Grid -->
                <div class="columns is-multiline">
                    <template x-for="book in books" :key="book.id">
                        <div class="column is-one-quarter-widescreen is-one-third-desktop is-half-tablet">
                            <div class="card has-hover-lift">
                                <div class="card-image has-gradient-emerald" style="min-height: 150px; display: flex; align-items: center; justify-content: center;">
                                    <figure class="image">
                                        <span class="icon is-large" style="font-size: 4rem;">
                                            <i class="fas fa-file-pdf has-text-white"></i>
                                        </span>
                                    </figure>
                                </div>
                                <div class="card-content">
                                    <p class="title is-6 has-text-grey-dark mb-2" x-text="book.title" style="min-height: 3rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;"></p>
                                    <p class="subtitle is-7 has-text-grey mb-1" x-text="book.author"></p>
                                    <p class="is-size-7 has-text-grey-light mb-3" x-text="book.subject || 'No subject'"></p>
                                    <div class="buttons">
                                        <button @click="viewPDF(book.id)" class="button is-success is-small is-fullwidth">
                                            <span class="icon is-small">
                                                <i class="fas fa-eye"></i>
                                            </span>
                                            <span>View PDF</span>
                                        </button>
                                        <button x-show="isAdmin" @click="uploadPDF(book.id)" class="button is-info is-small">
                                            <span class="icon is-small">
                                                <i class="fas fa-upload"></i>
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <div x-show="books.length === 0" class="has-text-centered py-6">
                    <p class="title is-4 has-text-grey-light">No digital books available</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Upload Modal -->
    <div x-show="showUploadModal" class="modal" :class="{'is-active': showUploadModal}" x-cloak>
        <div class="modal-background" @click="showUploadModal = false"></div>
        <div class="modal-card">
            <header class="modal-card-head has-background-info">
                <p class="modal-card-title has-text-white">Upload PDF</p>
                <button class="delete" @click="showUploadModal = false" aria-label="close"></button>
            </header>
            <section class="modal-card-body">
                <form @submit.prevent="handleUpload">
                    <div class="field">
                        <label class="label">Select PDF File *</label>
                        <div class="control">
                            <div class="file has-name is-fullwidth">
                                <label class="file-label">
                                    <input @change="fileSelected" class="file-input" type="file" accept=".pdf" required>
                                    <span class="file-cta">
                                        <span class="file-icon">
                                            <i class="fas fa-upload"></i>
                                        </span>
                                        <span class="file-label">
                                            Choose a fileâ€¦
                                        </span>
                                    </span>
                                    <span class="file-name" x-text="selectedFile ? selectedFile.name : 'No file selected'">
                                        No file selected
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </section>
            <footer class="modal-card-foot">
                <button @click="handleUpload" class="button is-info">Upload</button>
                <button @click="showUploadModal = false" class="button">Cancel</button>
            </footer>
        </div>
    </div>
</div>

<script>
    function digitalLibraryApp() {
        return {
            books: [],
            subjects: [],
            searchQuery: '',
            filterSubject: '',
            isAdmin: false,
            userName: '',
            showUploadModal: false,
            uploadBookId: null,
            selectedFile: null,

            async init() {
                const userRole = localStorage.getItem('user_role');
                this.isAdmin = userRole === 'admin' || userRole === 'librarian';
                this.userName = localStorage.getItem('full_name') || localStorage.getItem('username') || 'User';
                await this.loadBooks();
                await this.loadSubjects();
            },

            async loadBooks() {
                const token = localStorage.getItem('access_token');
                let url = '/api/digital-library?limit=500';
                if (this.searchQuery) url += `&search=${encodeURIComponent(this.searchQuery)}`;
                if (this.filterSubject) url += `&subject=${encodeURIComponent(this.filterSubject)}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    this.books = await response.json();
                }
            },

            async loadSubjects() {
                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/subjects', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    this.subjects = await response.json();
                }
            },

            searchBooks() {
                this.loadBooks();
            },

            viewPDF(bookId) {
                const token = localStorage.getItem('access_token');
                window.open(`/api/digital-library/view/${bookId}?token=${token}`, '_blank');
            },

            uploadPDF(bookId) {
                this.uploadBookId = bookId;
                this.showUploadModal = true;
            },

            fileSelected(event) {
                this.selectedFile = event.target.files[0];
            },

            async handleUpload() {
                if (!this.selectedFile) return;

                const token = localStorage.getItem('access_token');
                const formData = new FormData();
                formData.append('file', this.selectedFile);

                const response = await fetch(`/api/digital-library/upload/${this.uploadBookId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (response.ok) {
                    this.showUploadModal = false;
                    await this.loadBooks();
                    window.toast.success('PDF uploaded successfully');
                } else {
                    const error = await response.json();
                    window.toast.error(error.detail || 'Upload failed');
                }
            },

            logout() {
                localStorage.removeItem('access_token');
                localStorage.removeItem('user_role');
                localStorage.removeItem('user_id');
                localStorage.removeItem('username');
                localStorage.removeItem('full_name');
                window.location.href = '/login';
            }
        }
    }
</script>

<style>
    [x-cloak] { display: none !important; }
</style>
{% endblock %}
