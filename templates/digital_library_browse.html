{% extends "base.html" %}

{% block title %}Digital Library - TIC Nexus{% endblock %}

{% block extra_css %}
<script src="/static/js/auth-check.js"></script>
{% endblock %}

{% block content %}
<div class="columns is-gapless" style="min-height: 100vh;" x-data="digitalLibraryBrowseApp()">
    <!-- Sidebar -->
    {% set active_page = 'digital-library' %}
    {% include 'sidebar.html' %}

    <!-- Main Content -->
    <main class="column" style="background-color: #f8fafc;">
        <div class="section">
            <div class="container is-fluid">
                <!-- Header -->
                <div class="level mb-5">
                    <div class="level-left">
                        <div class="level-item">
                            <h2 class="title is-3 has-text-grey-dark">Digital Library</h2>
                        </div>
                    </div>
                    <div class="level-right">
                        <div class="level-item" x-show="isAdmin">
                            <button @click="openUploadModal" class="button is-success">
                                <span class="icon"><i class="fas fa-upload"></i></span>
                                <span>Upload Digital Book</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Search Bar - Prominent -->
                <div class="box mb-5 has-gradient-emerald" style="padding: 2rem;">
                    <div class="field">
                        <div class="control has-icons-left has-icons-right is-large">
                            <input 
                                x-model="searchQuery"
                                @input="debounceSearch"
                                type="text" 
                                placeholder="Search digital books by title, author, ISBN, or description..."
                                class="input is-large"
                                style="border-radius: 50px; font-size: 1.1rem;"
                            >
                            <span class="icon is-left is-large">
                                <i class="fas fa-search fa-lg"></i>
                            </span>
                            <span class="icon is-right is-large" x-show="searchQuery" @click="clearSearch" style="pointer-events: all; cursor: pointer;">
                                <i class="fas fa-times-circle fa-lg"></i>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="box mb-5">
                    <div class="columns">
                        <div class="column">
                            <div class="field">
                                <label class="label is-small">Subject</label>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select x-model="filterSubject" @change="searchBooks">
                                            <option value="">All Subjects</option>
                                            <template x-for="subject in subjects" :key="subject">
                                                <option :value="subject" x-text="subject"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="column">
                            <div class="field">
                                <label class="label is-small">Category</label>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select x-model="filterCategory" @change="searchBooks">
                                            <option value="">All Categories</option>
                                            <template x-for="category in categories" :key="category">
                                                <option :value="category" x-text="category"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="column">
                            <div class="field">
                                <label class="label is-small">Language</label>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select x-model="filterLanguage" @change="searchBooks">
                                            <option value="">All Languages</option>
                                            <template x-for="language in languages" :key="language">
                                                <option :value="language" x-text="language"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="column">
                            <div class="field">
                                <label class="label is-small">Format</label>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select x-model="filterFormat" @change="searchBooks">
                                            <option value="">All Formats</option>
                                            <option value="pdf">PDF</option>
                                            <option value="epub">EPUB</option>
                                            <option value="mobi">MOBI</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Count -->
                <div class="mb-4">
                    <p class="has-text-grey">
                        <span x-show="!loading">
                            Found <strong x-text="books.length"></strong> digital book<span x-show="books.length !== 1">s</span>
                        </span>
                        <span x-show="loading">
                            <i class="fas fa-spinner fa-spin"></i> Loading...
                        </span>
                    </p>
                </div>

                <!-- Books Grid -->
                <div class="columns is-multiline" x-show="!loading && books.length > 0">
                    <template x-for="book in books" :key="book.id">
                        <div class="column is-one-quarter-widescreen is-one-third-desktop is-half-tablet is-full-mobile">
                            <div class="card digital-book-card has-hover-lift" @click="viewBook(book.id)" style="cursor: pointer; height: 100%;">
                                <div class="card-image" :class="'has-gradient-' + getColorForFormat(book.file_format)" style="min-height: 180px; display: flex; align-items: center; justify-content: center; position: relative;">
                                    <figure class="image">
                                        <span class="icon" style="font-size: 5rem;">
                                            <i :class="getIconForFormat(book.file_format)" class="has-text-white"></i>
                                        </span>
                                    </figure>
                                    <!-- View Count Badge -->
                                    <span class="tag is-light" style="position: absolute; top: 10px; right: 10px;">
                                        <span class="icon is-small">
                                            <i class="fas fa-eye"></i>
                                        </span>
                                        <span x-text="book.view_count"></span>
                                    </span>
                                    <!-- Format Badge -->
                                    <span class="tag is-dark" style="position: absolute; bottom: 10px; left: 10px; text-transform: uppercase;">
                                        <span x-text="book.file_format"></span>
                                    </span>
                                </div>
                                <div class="card-content">
                                    <p class="title is-6 has-text-grey-dark mb-2" x-text="book.title" style="min-height: 3rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;" :title="book.title"></p>
                                    <p class="subtitle is-7 has-text-grey mb-2">
                                        <span class="icon is-small"><i class="fas fa-user"></i></span>
                                        <span x-text="book.author"></span>
                                    </p>
                                    <p class="is-size-7 has-text-grey-light mb-3">
                                        <span class="icon is-small"><i class="fas fa-tag"></i></span>
                                        <span x-text="book.subject || 'No subject'"></span>
                                    </p>
                                    <div class="is-size-7 has-text-grey-light">
                                        <span class="icon is-small"><i class="fas fa-download"></i></span>
                                        <span x-text="book.download_count"></span> downloads
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Loading State -->
                <div x-show="loading" class="has-text-centered py-6">
                    <span class="icon is-large has-text-grey-light">
                        <i class="fas fa-spinner fa-pulse fa-3x"></i>
                    </span>
                    <p class="title is-5 has-text-grey-light mt-4">Loading digital books...</p>
                </div>

                <!-- Empty State -->
                <div x-show="!loading && books.length === 0" class="has-text-centered py-6">
                    <span class="icon is-large has-text-grey-light">
                        <i class="fas fa-book-open fa-3x"></i>
                    </span>
                    <p class="title is-4 has-text-grey-light mt-4">No digital books found</p>
                    <p class="subtitle is-6 has-text-grey-light">
                        <span x-show="searchQuery || filterSubject || filterCategory || filterLanguage || filterFormat">
                            Try adjusting your search or filters
                        </span>
                        <span x-show="!(searchQuery || filterSubject || filterCategory || filterLanguage || filterFormat) && isAdmin">
                            Upload your first digital book to get started
                        </span>
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- Upload Modal -->
    <div class="modal" :class="{'is-active': showUploadModal}" x-cloak>
        <div class="modal-background" @click="closeUploadModal"></div>
        <div class="modal-card">
            <header class="modal-card-head has-background-success">
                <p class="modal-card-title has-text-white">Upload Digital Book</p>
                <button class="delete" @click="closeUploadModal" aria-label="close"></button>
            </header>
            <section class="modal-card-body">
                <form @submit.prevent="handleUpload" id="uploadForm">
                    <div class="field">
                        <label class="label">Title <span class="has-text-danger">*</span></label>
                        <div class="control">
                            <input x-model="uploadForm.title" class="input" type="text" placeholder="Enter book title" required>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">Author <span class="has-text-danger">*</span></label>
                        <div class="control">
                            <input x-model="uploadForm.author" class="input" type="text" placeholder="Enter author name" required>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">Subject</label>
                        <div class="control">
                            <input x-model="uploadForm.subject" class="input" type="text" placeholder="Enter subject (optional)">
                        </div>
                    </div>

                    <div class="field">
                        <label class="label">File <span class="has-text-danger">*</span></label>
                        <div class="control">
                            <div class="file has-name is-fullwidth">
                                <label class="file-label">
                                    <input @change="fileSelected" class="file-input" type="file" accept=".pdf,.epub,.mobi" required>
                                    <span class="file-cta">
                                        <span class="file-icon">
                                            <i class="fas fa-upload"></i>
                                        </span>
                                        <span class="file-label">
                                            Choose a fileâ€¦
                                        </span>
                                    </span>
                                    <span class="file-name" x-text="selectedFile ? selectedFile.name : 'No file selected'">
                                        No file selected
                                    </span>
                                </label>
                            </div>
                        </div>
                        <p class="help">Supported formats: PDF, EPUB, MOBI (Max 50MB)</p>
                    </div>

                    <div x-show="uploadError" class="notification is-danger is-light">
                        <button class="delete" @click="uploadError = ''"></button>
                        <span x-text="uploadError"></span>
                    </div>
                </form>
            </section>
            <footer class="modal-card-foot">
                <button @click="handleUpload" class="button is-success" :class="{'is-loading': uploading}" :disabled="uploading">
                    <span class="icon"><i class="fas fa-upload"></i></span>
                    <span>Upload</span>
                </button>
                <button @click="closeUploadModal" class="button" :disabled="uploading">Cancel</button>
            </footer>
        </div>
    </div>
</div>

<script>
    function digitalLibraryBrowseApp() {
        return {
            books: [],
            subjects: [],
            categories: [],
            languages: [],
            searchQuery: '',
            filterSubject: '',
            filterCategory: '',
            filterLanguage: '',
            filterFormat: '',
            isAdmin: false,
            userName: '',
            loading: true,
            showUploadModal: false,
            uploading: false,
            uploadError: '',
            selectedFile: null,
            searchTimeout: null,
            uploadForm: {
                title: '',
                author: '',
                subject: ''
            },

            async init() {
                // Check if user is logged in
                const token = localStorage.getItem('access_token');
                const userRole = localStorage.getItem('user_role');
                this.isAdmin = token && (userRole === 'admin' || userRole === 'librarian');
                this.userName = localStorage.getItem('full_name') || localStorage.getItem('username') || 'User';
                
                await Promise.all([
                    this.loadBooks(),
                    this.loadFilters()
                ]);
            },

            async loadBooks() {
                this.loading = true;
                const token = localStorage.getItem('access_token');
                let url = '/api/digital-library?limit=500';
                
                if (this.searchQuery) url += `&search=${encodeURIComponent(this.searchQuery)}`;
                if (this.filterSubject) url += `&subject=${encodeURIComponent(this.filterSubject)}`;
                if (this.filterCategory) url += `&category=${encodeURIComponent(this.filterCategory)}`;
                if (this.filterLanguage) url += `&language=${encodeURIComponent(this.filterLanguage)}`;
                if (this.filterFormat) url += `&file_format=${encodeURIComponent(this.filterFormat)}`;

                try {
                    const headers = {};
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    
                    const response = await fetch(url, { headers });
                    if (response.ok) {
                        this.books = await response.json();
                    } else {
                        window.toast.error('Failed to load digital books');
                    }
                } catch (error) {
                    console.error('Error loading books:', error);
                    window.toast.error('Network error while loading books');
                } finally {
                    this.loading = false;
                }
            },

            async loadFilters() {
                const token = localStorage.getItem('access_token');
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                try {
                    const [subjectsRes, categoriesRes, languagesRes] = await Promise.all([
                        fetch('/api/digital-library/filters/subjects', { headers }),
                        fetch('/api/digital-library/filters/categories', { headers }),
                        fetch('/api/digital-library/filters/languages', { headers })
                    ]);

                    if (subjectsRes.ok) this.subjects = await subjectsRes.json();
                    if (categoriesRes.ok) this.categories = await categoriesRes.json();
                    if (languagesRes.ok) this.languages = await languagesRes.json();
                } catch (error) {
                    console.error('Error loading filters:', error);
                }
            },

            debounceSearch() {
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => {
                    this.searchBooks();
                }, 300);
            },

            searchBooks() {
                this.loadBooks();
            },

            clearSearch() {
                this.searchQuery = '';
                this.searchBooks();
            },

            viewBook(bookId) {
                window.location.href = `/digital-library/${bookId}`;
            },

            getIconForFormat(format) {
                const icons = {
                    'pdf': 'fas fa-file-pdf',
                    'epub': 'fas fa-book',
                    'mobi': 'fas fa-book-reader'
                };
                return icons[format] || 'fas fa-file';
            },

            getColorForFormat(format) {
                const colors = {
                    'pdf': 'navy',
                    'epub': 'emerald',
                    'mobi': 'navy'
                };
                return colors[format] || 'navy';
            },

            openUploadModal() {
                this.showUploadModal = true;
                this.uploadError = '';
                this.uploadForm = { title: '', author: '', subject: '' };
                this.selectedFile = null;
            },

            closeUploadModal() {
                if (!this.uploading) {
                    this.showUploadModal = false;
                }
            },

            fileSelected(event) {
                const file = event.target.files[0];
                if (file) {
                    // Check file size (50MB limit)
                    if (file.size > 50 * 1024 * 1024) {
                        this.uploadError = 'File size must be less than 50MB';
                        event.target.value = '';
                        this.selectedFile = null;
                        return;
                    }
                    this.selectedFile = file;
                    this.uploadError = '';
                }
            },

            async handleUpload() {
                if (!this.uploadForm.title || !this.uploadForm.author || !this.selectedFile) {
                    this.uploadError = 'Please fill in all required fields';
                    return;
                }

                this.uploading = true;
                this.uploadError = '';
                const token = localStorage.getItem('access_token');
                const formData = new FormData();
                
                formData.append('title', this.uploadForm.title);
                formData.append('author', this.uploadForm.author);
                if (this.uploadForm.subject) {
                    formData.append('subject', this.uploadForm.subject);
                }
                formData.append('file', this.selectedFile);

                try {
                    const response = await fetch('/api/digital-library', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });

                    if (response.ok) {
                        const book = await response.json();
                        this.showUploadModal = false;
                        window.toast.success('Digital book uploaded successfully!');
                        // Navigate to detail page after short delay
                        setTimeout(() => {
                            window.location.href = `/digital-library/${book.id}`;
                        }, 500);
                    } else {
                        const error = await response.json();
                        this.uploadError = error.detail || 'Upload failed';
                        window.toast.error(this.uploadError);
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    this.uploadError = 'Network error. Please try again.';
                    window.toast.error('Network error. Please try again.');
                } finally {
                    this.uploading = false;
                }
            },

            logout() {
                localStorage.removeItem('access_token');
                localStorage.removeItem('user_role');
                localStorage.removeItem('user_id');
                localStorage.removeItem('username');
                localStorage.removeItem('full_name');
                window.location.href = '/';
            },

            openChangePasswordModal() {
                window.openChangePasswordModal();
            }
        }
    }
</script>

<style>
    [x-cloak] { display: none !important; }
    
    .digital-book-card {
        transition: all 0.3s ease;
    }
    
    .digital-book-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }
</style>

<!-- Include Change Password Modal -->
{% include 'change_password_modal.html' %}

{% endblock %}
